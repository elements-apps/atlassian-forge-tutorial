=== Display user information in Jira issue

To conclude this exercise, we will display our generated user into a Jira issue.
Instead of UI kit, we will use https://developer.atlassian.com/platform/forge/custom-ui/[Custom UI], the second way to build a graphical interface using Forge.

Custom UI is a more open way to build the front part than UI kit.
In fact, you can use anything (languages and technologies) you want.
The only thing Forge require in the end is static assets (HTML, CSS, JSS, ...).

When we created our Forge app at the beginning of this exercise, we used a Custom UI template.
Now it's time to dig into all the _"we will see this later"_ things.

[TIP]
.Resource
====
Documentation about Custom UI can be found on the https://developer.atlassian.com/platform/forge/custom-ui/[Forge documentation].
====

==== Custom UI: how does this work?

If you check the `./static/hello-world` directory, you will see a standalone React project.
In fact, this was generated by the Forge template we used previously.
The project you see is based on https://github.com/facebook/create-react-app[create-react-app], which provides a ready-to-use React application.

To be recognized as a "Custom UI project", you must declare a `resources` in the `manifest.yml`.
Hopefully, everything is ready thanks to the Forge template:

[source, yaml]
----
modules:
  jira:issuePanel:<2>
    - key: random-user-hello-world-panel
      resource: main
      resolver: <3>
        function: resolver
      viewportSize: medium
      title: random-user
      icon: https://developer.atlassian.com/platform/forge/images/issue-panel-icon.svg
  jira:adminPage:
    - key: random-user-administration
      function: run-administration
      title: Random user administration
  trigger:
    - key: issue-created-event
      function: issue-created
      events:
        - avi:jira:created:issue
  function:
    - key: resolver
      handler: index.handler
    - key: run-administration
      handler: administration.run
    - key: issue-created
      handler: trigger.run
resources: <1>
  - key: main
    path: static/hello-world/build
app:
  id: ari:cloud:ecosystem::app/9513507c-5fa1-4e5e-8fee-a5d7ef17a07e
permissions:
  scopes:
    - storage:app
    - read:issue:jira
    - read:issue-type:jira
    - read:user:jira
    - read:project:jira
    - read:status:jira
  external:
    fetch:
      backend:
        - https://randomuser.me <4>

----

<1> Our resource "main" is declared here.
The `path` tells Forge where static assets of our Custom UI can be found.
In our case, the output build directory of our hello-world React application is provided.
<2> This part was generated before using `forge create`, so Forge knows we want to be displayed in an Jira issue panel
<3> We tell Forge which function will be used to handle communication with our Custom UI project.
This function is also declared in the `function` part.
<4> Permissions added before to fetch the randomuser.me API

Let's dig in the `./src/index.js` file, which is declared as our `resolver`:

[source, jsx]
----
import Resolver from '@forge/resolver';

const resolver = new Resolver(); <1>

resolver.define('getText', (req) => { <2>
  console.log(req);

  return 'Hello, world!';
});

export const handler = resolver.getDefinitions(); <3>
----

<1> A resolver is created here. It will contain functions accessible in our Custom UI project.
<2> Here, we define the `getText` function. The `req` parameter will contain context about the invocation and also arguments used to call this function.
<3> Finally, all functions defined in the resolver are exported

This was for the "Forge side", not let's see how it's work in our Custom UI project by opening `./src/static/hello-world/src/App.js`:

[source, jsx]
----
import React, { useEffect, useState } from 'react';
import { invoke } from '@forge/bridge'; <1>

function App() {
  const [data, setData] = useState(null);

  useEffect(() => {
    invoke<string>('getText', { example: 'my-invoke-variable' }).then(response => setData(response)); <2>
  }, []);

  return (
    <div>
      {data ? data : 'Loading...'}
    </div>
  );
}

export default App;

----

<1> We retrieve the `invoke` method from the `@forge/bridge` package, which allow us to call functions defined in the previous resolver
<2> Here we call the `getText` method we declared before. We should receive a javascript `Promise` with the `Hello, world!` content.

So, what is this `@forge/bridge` ?
Custom UI **has no access to the Forge world** by default.
This means you can't directly use packages like `@forge/api`, contrary to previous parts.
This is where `@forge/bridge` is helpful: as indicated in the name, this package allows you to create a "bridge" between a Custom UI project and our Forge functions.
This way, you can continue to use all Forge features.

Let's do a simple test.
Go to your jira instance and open an issue.
You should see the Atlassian logo under the issue name.
Click on it, and your instance will ask you to allow the app to access Jira in a new tab.
You can see that displayed permissions match our `manifest.yml`.
Click on "Accept", and the app should be displayed:

image::allow-issue.png[]

As you can see, the "Hello, world!" text from our Forge function is displayed.
Here is what happens:

image::forge-bridge.png[]

Now, some setup before starting the final part of this exercise.

==== Adding Typescript

If you check our `./src` folder, you can see that `index.js` doesn't use Typescript.
Since Typescript is already configured in this directory, you can rename this file to `index.ts`.

[TIP]
====
* If you want to rename the `index` part of the file, ensure to also edit the `function` part of the `manifest.yml`
* If you want to rename the `.src/static/hello-word` directory, ensure to change the path in the `resources` part of the `manifest.yml`
====

Now regarding our Custom UI project in `./src/static/hello-world`, no Typescript is available here.
Let's add it using the following command:

[source, bach]
----
npm install typescript @types/node @types/react @types/react-dom
----

[NOTE]
====
The `package.json` file in `./src` is related to our Forge functions. The one in `./src/static/hello-world` only concerns our Custom UI project.
====

Once it's installed, we can replace `.js` extension of files in `./src/static/hello-world/src` with the `.tsx` one.
Like previously, we need to create the `tsconfig.json` file in `./src/static/hello-world` with this content:

[source, json]
----
{
  "compilerOptions": {
    "target": "es2017",
    "lib": [
      "dom",
      "dom.iterable",
      "esnext"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "esModuleInterop": true,
    "allowSyntheticDefaultImports": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true,
    "noFallthroughCasesInSwitch": true,
    "module": "esnext",
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "downlevelIteration": true
  },
  "include": [
    "src"
  ]
}

----

Typescript should find errors in `App.tsx`, so you can replace its content with this one:

[source, jsx]
----
import React, { useEffect, useState } from 'react';
import { invoke } from '@forge/bridge';

function App() {
  const [data, setData] = useState<string>();

  useEffect(() => {
    invoke('getText', { example: 'my-invoke-variable' }).then((response) => setData(response as string));
  }, []);

  return (
    <div>
      {data ? data : 'Loading...'}
    </div>
  );
}

export default App;
----

==== Working with Forge tunnel and hot reload

Now, each time we modify our Custom UI project, we need to run `npm run build` to generate our assets inside the `./build` folder, then run `forge deploy` to send assets on the Forge infrastructure.
As you see, it takes something like 1 minute to run these two commands.
When developing, this will be a problem.
That why Forge allow you to bind a local development server to the Forge tunnel.
Luckily, `create-react-app` comes with a dev server! What a good break ðŸ‘€

Let's start the server by running this command in `./static/hello-world`:

[source, bash]
----
npm start
----

You might encounter a build error about the `buffer` package. This can be solved by installing it:

[source, bash]
----
npm install buffer
npm start
----

Now, each time we edit something in our Custom UI project, the assets will be regenerated and available at http://localhost:3000/.
If you try to reach this address, you should receive this error: `TypeError: window.__bridge is undefined`.
It's expected: the `@forge/bridge` package only works on an Atlassian instance.

Then, we must tell Forge tunnel to use our web server to serve our Custom UI content.
For this, the https://developer.atlassian.com/platform/forge/tunneling/#tunneling-with-custom-ui[Atlassian documentation] is clear:

[source, yaml]
----
modules:
  jira:issuePanel:
    - key: random-user-hello-world-panel
      resource: main
      resolver:
        function: resolver
      viewportSize: medium
      title: random-user
      icon: https://developer.atlassian.com/platform/forge/images/issue-panel-icon.svg
  jira:adminPage:
    - key: random-user-administration
      function: run-administration
      title: Random user administration
  trigger:
    - key: issue-created-event
      function: issue-created
      events:
        - avi:jira:created:issue
  function:
    - key: resolver
      handler: index.handler
    - key: run-administration
      handler: administration.run
    - key: issue-created
      handler: trigger.run
resources:
  - key: main
    path: static/hello-world/build
    tunnel: <1>
      port: 3000
app:
  id: ari:cloud:ecosystem::app/9513507c-5fa1-4e5e-8fee-a5d7ef17a07e
permissions:
  scopes:
    - storage:app
    - read:issue:jira
    - read:issue-type:jira
    - read:user:jira
    - read:project:jira
    - read:status:jira
  external:
    fetch:
      backend:
        - https://randomuser.me

----
<1> We just need to add the `tunnel` property under our Custom UI resource. Last thing to add is the port to listen, in our case 3000.

Now, `forge deploy` the changes, run `forge tunnel` and open (or reload) an issue view on your Atlassian instance.
If it's working, you should see these logs:

[source]
----
Received proxy request. Serving file index.html for resource main from specified address http://localhost:3000 <1>
CSP violation detected for 'style-src' while serving content at http://localhost:8001/
For an app to share data with external resources or use custom CSP, follow the steps in: https://go.atlassian.com/forge-content-security-and-egress-controls <2>
----
<1> This line indicates that the content is served from your local dev server
<2> The second is related to a Content Security Policy (CSP) issue.

==== Handling CSP

Our Custom UI project has some restrictions regarding the Forge security requirement.
As noted by the previous log, our React app generate `<style>` in the served `index.html`, which by default is not allowed by Forge.

To avoid CSP, edit the manifest with the following content:


[source, yaml]
----
modules:
  jira:issuePanel:
    - key: random-user-hello-world-panel
      resource: main
      resolver:
        function: resolver
      viewportSize: medium
      title: random-user
      icon: https://developer.atlassian.com/platform/forge/images/issue-panel-icon.svg
  jira:adminPage:
    - key: random-user-administration
      function: run-administration
      title: Random user administration
  trigger:
    - key: issue-created-event
      function: issue-created
      events:
        - avi:jira:created:issue
  function:
    - key: resolver
      handler: index.handler
    - key: run-administration
      handler: administration.run
    - key: issue-created
      handler: trigger.run
resources:
  - key: main
    path: static/hello-world/build
    tunnel:
      port: 3000
app:
  id: ari:cloud:ecosystem::app/9513507c-5fa1-4e5e-8fee-a5d7ef17a07e
permissions:
  scopes:
    - storage:app
    - read:issue:jira
    - read:issue-type:jira
    - read:user:jira
    - read:project:jira
    - read:status:jira
  content: <1>
    styles:
      - 'unsafe-inline'
  external:
    fetch:
      backend:
        - https://randomuser.me
----
<1> We tell Forge we need to allow inline CSS

Now, in the `./src/static/hello-world/public/index.html` file, add the following line:

[source, html]
----
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Security-Policy" content="style-src 'self' 'unsafe-inline'" /> <1>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>React App</title>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
  </body>
</html>

----
<1> We also add the CSP part in our Custom UI project

Since we edit permissions, remember to `forge deploy` and `forge install --upgrade`.

After reloading the issue view, our app should be displayed correctly.
Try editing `App.tsx` by adding some text: after saving, your app is directly updated.

[TIP]
.Resource
====
You can find more information about Forge CSP in the https://developer.atlassian.com/platform/forge/manifest-reference/permissions/[Forge documentation].
====

==== Final exercise

Time to shine! As usual, do it yourself, solution available if needed in the `App.tsx` file.

**What you must do:**

First thing to do is retrieve user information we stored previously in the Jira Issue Properties.
Two ways are available to perform this: by `invoke`ing a function defined in the resolver or using `requestJira` method (also from the `@forge/bridge` package).
Once the data are retrieved, try to display simple information like the generated user picture, it's name and email.

**Resources:**

* https://developer.atlassian.com/platform/forge/custom-ui/[Custom UI guide]
* https://developer.atlassian.com/platform/forge/custom-ui-bridge/bridge/[Custom UI bridge methods]
* https://developer.atlassian.com/platform/forge/runtime-reference/properties-api/[Jira issue properties]
* https://developer.atlassian.com/platform/forge/manifest-reference/permissions/[Permission documentation]

**Additional notes:**

* Don't forget to start your Forge tunnel and dev server
* Using the `requestJira` of `@forge/bridge` perform the request "as the current user" and not in the name of your app.
* Make sure to check permissions required by the Atlassian API you're using
* You can use https://atlassian.design/components[Atlaskit components] to provide an Atlassian-like user experience.
Make sure to manage this case.
* Sometime, some errors cane be solved by restarting the Forge tunnel / dev server
* Displaying images from randomuser.me will require additional egress permission

image:issue-view.png[]

Once it's done: run `npm run build` in  `./src/static/helloword` to create an optimized build of your Custom UI project, then run `forge deploy`.
Now you can access your app without using Forge tunnel.
